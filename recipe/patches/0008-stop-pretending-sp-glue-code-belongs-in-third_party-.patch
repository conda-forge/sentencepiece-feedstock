From e8627700956344a8732828e7604dd9835d011433 Mon Sep 17 00:00:00 2001
From: "H. Vetinari" <h.vetinari@gmx.com>
Date: Mon, 21 Feb 2022 12:50:47 +1100
Subject: [PATCH 8/8] stop pretending sp glue code belongs in third_party/absl

---
 src/CMakeLists.txt                            |  4 ++-
 src/error.cc                                  |  6 ++---
 src/init.h                                    |  4 +--
 src/init_test.cc                              |  1 +
 .../absl/flags/flag.cc => src/parse.cc        | 13 +++++-----
 third_party/absl/flags/flag.h => src/parse.h  | 15 +++++------
 src/testharness.h                             |  2 +-
 third_party/absl/flags/parse.h                | 25 -------------------
 8 files changed, 23 insertions(+), 47 deletions(-)
 rename third_party/absl/flags/flag.cc => src/parse.cc (97%)
 rename third_party/absl/flags/flag.h => src/parse.h (80%)
 delete mode 100644 third_party/absl/flags/parse.h

diff --git a/src/CMakeLists.txt b/src/CMakeLists.txt
index e446b49..05cc51d 100644
--- a/src/CMakeLists.txt
+++ b/src/CMakeLists.txt
@@ -13,7 +13,9 @@
 # limitations under the License.!
 
 if (SPM_USE_EXTERNAL_ABSL)
-  set(ABSL_FLAGS_SRCS "")
+  # originally part of third_party/absl, but actually
+  # only relevant for sentencepiece; now moved.
+  set(ABSL_FLAGS_SRCS "parse.cc")
   set(ABSL_STRINGS_SRCS "")
   list(APPEND SPM_LIBS absl::strings)
   list(APPEND SPM_LIBS absl::flags)
diff --git a/src/error.cc b/src/error.cc
index ab4675d..6d30f87 100644
--- a/src/error.cc
+++ b/src/error.cc
@@ -21,9 +21,9 @@
 // Naive workaround to define minloglevel on external absl package.
 // We want to define them in other cc file.
 #include "absl/flags/flag.h"
-#include "absl/flags/parse.h"
-ABSL_FLAG(int32, minloglevel, 0,
-          "Messages logged at a lower level than this don't actually.");
+ABSL_FLAG(int, minloglevel, 0,
+          "Messages logged at a lower level than this don't actually get "
+          "logged anywhere");
 #endif
 
 namespace sentencepiece {
diff --git a/src/init.h b/src/init.h
index acfda8a..c06bc9f 100644
--- a/src/init.h
+++ b/src/init.h
@@ -16,15 +16,15 @@
 #define INIT_H_
 
 #include "common.h"
+#include "parse.h"
 #include "absl/flags/flag.h"
-#include "absl/flags/parse.h"
 
 ABSL_DECLARE_FLAG(int32, minloglevel);
 
 namespace sentencepiece {
 inline void ParseCommandLineFlags(const char *usage, int *argc, char ***argv,
                                   bool remove_arg = true) {
-  const auto unused_args = absl::ParseCommandLine(*argc, *argv);
+  const auto unused_args = sentencepiece::ParseCommandLine(*argc, *argv);
 
   if (remove_arg) {
     char **argv_val = *argv;
diff --git a/src/init_test.cc b/src/init_test.cc
index e5cd2e4..951b389 100644
--- a/src/init_test.cc
+++ b/src/init_test.cc
@@ -16,6 +16,7 @@
 
 #include "common.h"
 #include "testharness.h"
+#include "absl/flags/flag.h"
 
 ABSL_FLAG(int32, int32_f, 10, "int32_flags");
 ABSL_FLAG(bool, bool_f, false, "bool_flags");
diff --git a/third_party/absl/flags/flag.cc b/src/parse.cc
similarity index 97%
rename from third_party/absl/flags/flag.cc
rename to src/parse.cc
index e7ac841..b729691 100644
--- a/third_party/absl/flags/flag.cc
+++ b/src/parse.cc
@@ -12,17 +12,18 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.!
 
-#include "third_party/absl/flags/flag.h"
-
 #include <algorithm>
 #include <iostream>
 #include <map>
 #include <sstream>
 #include <string>
 
+#include "parse.h"
+
 #include "config.h"
-#include "src/common.h"
-#include "src/util.h"
+#include "common.h"
+#include "util.h"
+#include "absl/flags/flag.h"
 
 ABSL_FLAG(bool, help, false, "show help");
 ABSL_FLAG(bool, version, false, "show version");
@@ -30,7 +31,7 @@ ABSL_FLAG(int, minloglevel, 0,
           "Messages logged at a lower level than this don't actually get "
           "logged anywhere");
 
-namespace absl {
+namespace sentencepiece {
 namespace internal {
 namespace {
 template <typename T>
@@ -218,4 +219,4 @@ std::vector<char *> ParseCommandLine(int argc, char *argv[]) {
 
   return output_args;
 }
-}  // namespace absl
+}  // namespace sentencepiece
diff --git a/third_party/absl/flags/flag.h b/src/parse.h
similarity index 80%
rename from third_party/absl/flags/flag.h
rename to src/parse.h
index e540edf..832e9b3 100644
--- a/third_party/absl/flags/flag.h
+++ b/src/parse.h
@@ -12,15 +12,15 @@
 // See the License for the specific language governing permissions and
 // limitations under the License.!
 
-#ifndef ABSL_FLAGS_FLAG_H_
-#define ABSL_FLAGS_FLAG_H_
+#ifndef SENTENCEPIECE_FLAG_H_
+#define SENTENCEPIECE_FLAG_H_
 
 #include <functional>
 #include <memory>
 #include <string>
 #include <vector>
 
-namespace absl {
+namespace sentencepiece {
 namespace internal {
 struct FlagFunc;
 
@@ -52,11 +52,8 @@ void SetFlag(Flag<T> *flag, const V &v) {
   const T value(v);
   flag->set_value(value);
 }
-}  // namespace absl
 
-#define ABSL_FLAG(Type, name, defautl_value, help) \
-  absl::Flag<Type> FLAGS_##name(#name, #Type, help, defautl_value);
+std::vector<char *> ParseCommandLine(int argc, char *argv[]);
+}  // namespace sentencepiece
 
-#define ABSL_DECLARE_FLAG(Type, name) extern absl::Flag<Type> FLAGS_##name;
-
-#endif  // ABSL_FLAGS_FLAG_H_
+#endif  // SENTENCEPIECE_FLAG_H_
diff --git a/src/testharness.h b/src/testharness.h
index 98317ad..8619bfa 100644
--- a/src/testharness.h
+++ b/src/testharness.h
@@ -21,8 +21,8 @@
 #include <string>
 
 #include "common.h"
+#include "parse.h"
 #include "absl/flags/flag.h"
-#include "absl/flags/parse.h"
 #include "absl/strings/string_view.h"
 
 ABSL_DECLARE_FLAG(std::string, test_tmpdir);
diff --git a/third_party/absl/flags/parse.h b/third_party/absl/flags/parse.h
deleted file mode 100644
index 6a06e63..0000000
--- a/third_party/absl/flags/parse.h
+++ /dev/null
@@ -1,25 +0,0 @@
-// Copyright 2016 Google Inc.
-//
-// Licensed under the Apache License, Version 2.0 (the "License");
-// you may not use this file except in compliance with the License.
-// You may obtain a copy of the License at
-//
-//     http://www.apache.org/licenses/LICENSE-2.0
-//
-// Unless required by applicable law or agreed to in writing, software
-// distributed under the License is distributed on an "AS IS" BASIS,
-// WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
-// See the License for the specific language governing permissions and
-// limitations under the License.!
-
-#ifndef ABSL_FLAGS_PARSE_H_
-#define ABSL_FLAGS_PARSE_H_
-
-#include <vector>
-
-namespace absl {
-
-std::vector<char *> ParseCommandLine(int argc, char *argv[]);
-}  // namespace absl
-
-#endif  // ABSL_FLAGS_PARSE_H_
-- 
2.32.0.windows.2

